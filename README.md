## Ansibleä¸»æœºå·¡æ£€ç”Ÿæˆç½‘é¡µæŠ¥å‘Š

## é¡¹ç›®åœ°å€
```bash
https://github.com/gpjdean/AnsibleHealthCheck.git
```


## åŠŸèƒ½ç‰¹ç‚¹ï¼š
â€¢ âš¡è‡ªåŠ¨åŒ–å·¡æ£€ï¼š é€šè¿‡ Ansible Playbook ç¼–æ’å·¡æ£€ä»»åŠ¡ï¼Œå®ç°ä¸€é”®è‡ªåŠ¨åŒ–å·¡æ£€ï¼Œå¤§å¤§æé«˜è¿ç»´æ•ˆç‡ã€‚
â€¢ ğŸ“Šå¤šç»´åº¦æ£€æŸ¥ï¼š æ”¯æŒ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€æœåŠ¡ç­‰å¤šä¸ªç»´åº¦çš„æ£€æŸ¥ï¼Œå…¨é¢æŒæ¡æœåŠ¡å™¨è¿è¡ŒçŠ¶å†µã€‚
â€¢ ğŸ”§çµæ´»æ‰©å±•ï¼š åŸºäº Ansible çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œå¯ä»¥è½»æ¾æ‰©å±•è‡ªå®šä¹‰æ£€æŸ¥é¡¹ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚ã€‚
â€¢ ğŸ–¥ï¸å¯è§†åŒ–æŠ¥å‘Šï¼š ç”Ÿæˆ HTML æ ¼å¼çš„å·¡æ£€æŠ¥å‘Šï¼Œç›´è§‚å±•ç¤ºå„é¡¹æ•°æ®ç»“æœã€‚
â€¢ ğŸ“¡é›†ä¸­åŒ–ç®¡ç†ï¼š é€šè¿‡ Ansible Tower æˆ– AWX ç­‰å¹³å°ï¼Œå®ç°é›†ä¸­åŒ–å·¡æ£€ç®¡ç†ï¼Œæé«˜è¿ç»´æ•ˆç‡ã€‚

## ä½¿ç”¨åœºæ™¯ï¼š
âœ…æ—¥å¸¸å·¡æ£€ï¼š å®šæœŸæ‰§è¡Œå·¡æ£€ä»»åŠ¡ï¼ŒåŠæ—¶å‘ç°æ½œåœ¨é—®é¢˜ï¼Œä¿éšœæœåŠ¡å™¨ç¨³å®šè¿è¡Œã€‚

ğŸ”æ•…éšœæ’æŸ¥ï¼š é€šè¿‡å·¡æ£€æŠ¥å‘Šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œç¼©çŸ­æ•…éšœæ¢å¤æ—¶é—´ã€‚

ğŸ‘¥æ‰¹é‡ç®¡ç†ï¼š é€‚ç”¨äºå¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤çš„å·¡æ£€ï¼Œæé«˜è¿ç»´æ•ˆç‡ã€‚

ğŸ“§æŠ¥å‘Šå½’æ¡£ï¼š è‡ªåŠ¨å°†å·¡æ£€æŠ¥å‘Šå‘é€è‡³é‚®ç®±ï¼Œå®ç°è¿œç¨‹ç›‘æ§ä¸å†å²æ•°æ®å½’æ¡£ï¼Œä¾¿äºåç»­åˆ†æã€‚

## é¡¹ç›®ä¼˜åŠ¿ï¼š
â±ï¸é«˜æ•ˆèŠ‚çœäººåŠ›ï¼š è‡ªåŠ¨åŒ–é‡‡é›†ä¸æŠ¥å‘Šç”Ÿæˆå¤§å¤§é™ä½äº†æ‰‹å·¥å·¡æ£€çš„å·¥ä½œé‡ï¼Œé‡Šæ”¾è¿ç»´äººå‘˜ç²¾åŠ›ã€‚

ğŸ“ˆæ•°æ®æ ‡å‡†åŒ–ï¼š ç»Ÿä¸€çš„æŠ¥å‘Šæ¨¡æ¿ä¿è¯äº†å·¡æ£€æ•°æ®çš„æ ¼å¼ä¸€è‡´ï¼Œä¾¿äºæ¯”å¯¹ä¸è¶‹åŠ¿åˆ†æã€‚

ğŸš¨å®æ—¶é¢„è­¦ï¼š æŠ¥å‘Šä¸­å¯é€šè¿‡é¢œè‰²é«˜äº®æ ‡æ³¨å¼‚å¸¸çŠ¶æ€ï¼Œå¸®åŠ©è¿ç»´äººå‘˜ç¬¬ä¸€æ—¶é—´å‘ç°é—®é¢˜ã€‚

âš™ï¸æ˜“éƒ¨ç½²ç»´æŠ¤ï¼š åŸºäº Ansible çš„è§£å†³æ–¹æ¡ˆéƒ¨ç½²ç®€å•ï¼Œåªéœ€ä¿®æ”¹å°‘é‡é…ç½®å˜é‡å³å¯é€‚åº”ä¸åŒç¯å¢ƒï¼›åŒæ—¶æ”¯æŒçµæ´»æ‰©å±•å·¡æ£€é¡¹ã€‚

ğŸŒå¤šç§æŸ¥çœ‹æ–¹å¼ï¼š æŠ¥å‘Šæ—¢æ”¯æŒé‚®ä»¶ç›´è¾¾ï¼Œä¹Ÿå¯é€šè¿‡æµè§ˆå™¨åœ¨çº¿é¢„è§ˆï¼Œæ»¡è¶³å¤šç§è¿ç»´éœ€æ±‚ã€‚

âœ¨ç®€å•æ˜“ç”¨ï¼š åŸºäº Ansible çš„å£°æ˜å¼è¯­æ³•ï¼Œæ˜“äºä¸Šæ‰‹ï¼Œæ— éœ€ç¼–å†™å¤æ‚è„šæœ¬ã€‚

ğŸ†“å¼€æºå…è´¹ï¼š é¡¹ç›®å¼€æºå…è´¹ï¼Œæ‚¨å¯ä»¥è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹ã€‚



## å®‰è£…Ansible
```bash
yum -y install epel-release
yum -y install ansible
ansible --version
```



## å…‹éš†ä»£ç 
```bash
[root@instance-euwvmd1u ~]# git clone https://ghfast.top/https://github.com/gpjdean/AnsibleHealthCheck.git
Cloning into 'ansible-HealthCheck'...
remote: Enumerating objects: 40, done.
remote: Counting objects: 100% (40/40), done.
remote: Compressing objects: 100% (26/26), done.
remote: Total 40 (delta 12), reused 35 (delta 7), pack-reused 0 (from 0)
Unpacking objects: 100% (40/40), done.
```



## ä¿®æ”¹é¡¹ç›®ansible.cfgé…ç½®
```bash
# è¿›å…¥åˆ°é¡¹ç›®è·¯å¾„
[root@instance-euwvmd1u ~]# cd ansible-HealthCheck

# æŒ‡ç©ºæ–‡ä»¶å†…å®¹
[root@instance-euwvmd1u ansible-HealthCheck]# >ansible.cfg 

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„å†…å®¹å†™å…¥åˆ°ansible.cfgæ–‡ä»¶å†…
[root@instance-euwvmd1u ansible-HealthCheck]# vim ansible.cfg

[defaults]
host_key_checking=False
remote_user=root
filter_plugins=/root/ansible-HealthCheck/filter_plugins
[inventory]
[privilege_escalation]
[paramiko_connection]
[ssh_connection]
[persistent_connection]
[accelerate]
[selinux]
[colors]
[diff]
```


## é…ç½®hostsä¸»æœºä¿¡æ¯
```bash
[root@instance-euwvmd1u ansible-HealthCheck]# vim hosts
# å†…å®¹å¦‚ä¸‹
[k8s]
120.48.168.44
[k8s:vars]
ansible_ssh_user="root"
ansible_ssh_pass="ä½ çš„ä¸»æœºå¯†ç "
```

## æŠ¥å‘ŠåŠé‚®ç®±é…ç½®ã€å¯é€‰ã€‘
```bash
vim /root/AnsibleHealthCheck/os-check/defaults/main.yamlï¼Œä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š
æŠ¥å‘Šç›®å½•ï¼šcheck_report_path	è®¾ç½®æŠ¥å‘Šç”Ÿæˆç›®å½•ï¼ˆä¾‹å¦‚ /tmpï¼‰
SMTPç›¸å…³å˜é‡ï¼ˆcheck_mail_hostã€check_mail_portã€check_mail_usernameã€check_mail_passwordã€check_mail_toï¼‰æ ¹æ®å®é™…æƒ…å†µå¡«å†™
```

## æ‰§è¡Œå‰§æœ¬ï¼Œè¿›è¡Œå·¡æ£€
```bash
[root@instance-euwvmd1u AnsibleHealthCheck]# ansible-playbook -i hosts roles/os-check.yaml --limit k8s

PLAY [k8s] **********************************************************************************************************************************************************************************

TASK [os-check : Get system check data.] ****************************************************************************************************************************************************
changed: [120.48.168.44]

TASK [os-check : Generate report file.] *****************************************************************************************************************************************************
changed: [120.48.168.44]

TASK [os-check : Get report file content.] **************************************************************************************************************************************************
ok: [120.48.168.44]

TASK [os-check : Send a report by email.] ***************************************************************************************************************************************************
skipping: [120.48.168.44]

PLAY RECAP **********************************************************************************************************************************************************************************
120.48.168.44              : ok=3    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0 
```



## é…ç½®hostsä¸»æœºä¿¡æ¯
```bash
# å‰å°æ‰§è¡Œ
[root@instance-euwvmd1u AnsibleHealthCheck]# cd /tmp/ && python -m SimpleHTTPServer 30000
Serving HTTP on 0.0.0.0 port 30000 ...


# åå°è¿è¡Œ
cd /tmp/ && nohup python -m SimpleHTTPServer 30000 >/dev/null2 >&1 &
```


## é…ç½®hostsä¸»æœºä¿¡æ¯
```bash
http://120.48.168.44:30000/report-2025-12-26.html
```
